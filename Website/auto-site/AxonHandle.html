<html>
<head>
<title> index </title>
<link rel=stylesheet type="text/css" href="/site-resources/base.css">
<link rel=stylesheet type="text/css" href="/site-resources/pandoc.css">
</head>
<body>
<div class="banner">
<P> <a href="/Home.html">Home</a> | 
    <a href="/About.html">About</a> | 
    <a href="/RecentChanges.html">Recent Changes</a> | 
    <a href="/Documentation.html">Documentation</a> |
    <a href="/Community.html">Community</a>
</div>
<div class="pagecontainer">
<div class="pagesection">
<div id="pagenote">
<p>March 2024 - This site, and Kamaelia are <a href="https://github.com/sparkslabs/kamaelia/issues/15">being updated</a>. There is significant work needed, and <a href="https://github.com/sparkslabs/kamaelia/pulls">PRs</a> are welcome.
</div>
<h1 id="axon-component-handles">Axon Component Handles</h1>
<p>The purpose behind Axon.Handle's is to allow the use of Kamaelia
based components and systems in non-Kamaelia systems, in a relatively
intuitive way.<br />
</p>
<h2 id="premise">Premise</h2>
<p>The name <strong>Handle</strong> derives from the concept of a
file-handle. We dropped the name "LikeFile" since whilst it derives from
the concept of a file handle, it doesn't use the same API as file() for
some good reasons we'll come back to.<br />
</p>
<p>A file handle is an opaque thing that you can <em>.write()</em> data
to, and <em>.read()</em> data from. This is a very simple concept and
belies a huge amount of parallel activity happening concurrently to your
application. The file system is taking your data and typically buffering
it into blocks. Those blocks then may need padding, and depending on the
file system, may actually be written immediately to the end of a cyclone
buffer in a journal with some write operations. Then periodically those
buffers get flushed to the actual disk.</p>
<p>Based on the fact that file handles are a very natural thing for
people to work with, based on their ubiquity, and the fact that it masks
the fact you're accessing a concurrent system from a linear one, that's
why we've taken this approach for integrating Kamaelia components (which
are naturally parallel) with non-Kamaelia code, which is typically not
parallel.<br />
</p>
<p>For simplicity of implementation, initially the implementation of
Handle supports only the equivalent of non-blocking file handles. This
has two implications:</p>
<ul>
<li>Reading data from a Handle may fail, since there may not be any
ready yet. This is chosen in preference to a blocking operation<br />
</li>
<li>Writing data to a Handle may also fail, since the component may not
actually be ready to receive data from us.<br />
</li>
</ul>
<h2 id="running-the-axon-scheduler-in-the-background">Running the Axon
Scheduler in the Background</h2>
<p>Clearly for this to work, Kamaelia's core - Axon - needs a way of
running components in the background. ie a way of putting the scheduler
in the background. This is actually pretty trivial, and can be used in a
very basic way (say, to run an Echo Protocol server in the background)
like this:<br />
<br />
</p>
<blockquote>
<pre><code>from Axon.background import background

# Start the scheduler in a background thread
#
background().start()

# Add something to run in the background.
from Kamaelia.Protocol.EchoProtocol import EchoProtcol
from Kamaelia.Chassis.ConnectedServer import SimpleServer

# Due to background().start() above, the following starts running in
# the background immediately. 
SimpleServer(protocol=EchoProtcol, port=1500).activate()

# Do something else in the foreground.
import time
while 1:
     time.sleep(1)
     print &quot;Ptang!&quot;</code></pre>
</blockquote>
<p>As should be clear from this, the scheduler is started in the
background, the server is activated and then system sits waiting for
people to connect whilst periodically going "Ptang!"<br />
</p>
<h2 id="example-component">Example Component</h2>
<p>We'll use the following component in our examples below:</p>
<blockquote>
<pre><code>class Reverser(Axon.Component.component):
    Inboxes = {
         &quot;inbox&quot;: &quot;We receive data to reverse here&quot;,
         &quot;control&quot;: &quot;We shutdown when a message is sent here&quot;
    }
    Outboxes = {
         &quot;outbox&quot;: &quot;We pass on the reversed message here&quot;,
         &quot;signal&quot;: &quot;We pass on any shutdown message that we receive here.&quot;
    }

    def main(self):
        while not self.dataReady(&quot;control):
            while self.dataReady(&#39;inbox&#39;):
                item = self.recv(&#39;inbox&#39;)
                self.send(item[::-1], &#39;outbox&#39;) # reverse the string

            if not self.anyReady():
                self.pause()

            yield 1

        self.send( self.recv(&quot;control), &quot;signal&quot; ) # pass on the shutdown</code></pre>
</blockquote>
<p>Now, clearly this is a simple component, but it be anything. If could
for example be a component that forwards each line to
translate.google.com or babelfish.av.com, to translate the provided
words into a different language. The usage would still be the same -
messages coming in inbox "inbox", and transformed data coming out outbox
"outbox".<br />
</p>
<h2 id="usage">Usage</h2>
<p>Given the example component above, we decide to manually feed it the
contents of stdin.<br />
</p>
<p>First of all we need our imports:<br />
</p>
<blockquote>
<pre><code>from Axon.Handle import Handle

from Axon.background import background

import Queue</code></pre>
</blockquote>
<p>Queue is needed because currently the exceptions thrown by Handle
(when the Handle isn't ready) are from that module.<br />
</p>
<p>Start the scheduler in the background:</p>
<blockquote>
<pre><code>background().start()</code></pre>
</blockquote>
<p>Start our Reverser component in the background, inside a Handle:</p>
<blockquote>
<pre><code>reverser = Handle(Reverser()).activate()</code></pre>
</blockquote>
<p>The it's just a matter of using it:</p>
<blockquote>
<pre><code>while True:
    line = sys.stdin.readline()
    if line == &quot;&quot;:
       break
    line = line.rstrip() # get rid of newline - looks odd otherwise :)

    reverser.put(line, &quot;inbox&quot;)

    while 1:
        try:
            enil = reverser.get(&quot;outbox&quot;)
            break
        except Queue.Empty:
            time.sleep(0.1)

    print enil</code></pre>
</blockquote>
<p>What should be clear here is that we feed data into the reverser
using the .put() method.</p>
<p>The reason why we don't use a file-like object[1] here also becomes
clear : 1) unlike read()/write() we have multiple possible destinations
for the data - "inbox", "control", and we also have multiple sources of
data "outbox", "signal". 2) Also, rather than shipping over binary data,
we're passing over arbitrary python objects. Whilst in this case this
happens to be strings it could be anything from simple records in
dictionaries through to video data.<br />
</p>
<blockquote>
<p>[1] ie using the file API of write/read</p>
</blockquote>
<h2 id="other-examples">Other Examples</h2>
<p>Other examples are in the Axon distribution and also in the Kamaelia
Distribution. These can be browsed online here:<br />
</p>
<ul>
<li><a
href="http://code.google.com/p/kamaelia/source/browse/trunk/Code/Python/Axon/Examples/Handles/">Axon
Handle Examples</a></li>
<li><a
href="http://code.google.com/p/kamaelia/source/browse/trunk/Code/Python/Kamaelia/Examples/Handles/">Kamaelia
Handle Examples</a></li>
</ul>
<h2 id="limitations">Limitations</h2>
<p>Limitations:<br />
</p>
<ul>
<li>It currently will only allow access to components with the
default/standard inboxes of inbox/control/signal/outbox.</li>
<li>This is a known limitation, but covers a wide class of
situations.</li>
</ul>
<p><br />
</p>

</div> <!-- end section -->
</div> <!-- end page container -->

<div class="banner">
<a href="https://www.bbc.co.uk/rd"><img src="/site-resources/BBCRD_Logo.jpg"></a>
<P id="mini">  Kamaelia is an open source project originated from and guided
by <a href="https://www.bbc.co.uk/rd">BBC Research.</a> For more information
browse the site or get in contact.
<br>This is an ongoing community based development site.  As a result the
contents of this page is the opinions of the contributors of the pages
involved not the organisations involved.  Specificially, this page may
contain personal views which are not the views of the BBC.

<br>(C) Copyright 2004-2024 Kamaelia Contributors, including the British
Broadcasting Corporation, All Rights Reserved.
</div>
</body>
</html>
