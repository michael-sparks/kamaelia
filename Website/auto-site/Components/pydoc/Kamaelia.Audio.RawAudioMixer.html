<html>
<head>
<title> index </title>
<link rel=stylesheet type="text/css" href="/site-resources/base.css">
<link rel=stylesheet type="text/css" href="/site-resources/pandoc.css">
</head>
<body>
<div class="banner">
<P> <a href="/Home.html">Home</a> | <a href="/About.html">About</a> | <a href="/Developers.html">Developers</a>
</div>
<div class="pagecontainer">
<div class="pagesection">
<div id="pagenote">
<p>Feb 2024 - This site, and Kamaelia are <a href="https://github.com/sparkslabs/kamaelia/issues/15">being updated</a>. There is significant work needed, and <a href="https://github.com/sparkslabs/kamaelia/pulls">PRs</a> are welcome.
</div>
<div class="container">
<h1 id="kamaelia.audio.rawaudiomixer"><a href="/Components/pydoc/Kamaelia.html" class="reference">Kamaelia</a>.<a href="/Components/pydoc/Kamaelia.Audio.html" class="reference">Audio</a>.<a href="/Components/pydoc/Kamaelia.Audio.RawAudioMixer.html" class="reference">RawAudioMixer</a></h1>
<section>
<div class="container">
<ul>
<li><strong>component <a href="/Components/pydoc/Kamaelia.Audio.RawAudioMixer.RawAudioMixer.html" class="reference">RawAudioMixer</a></strong></li>
</ul>
</div>
<ul>
<li><a href="#549" class="reference">Multi-source Raw Audio Mixer</a>
<ul>
<li><a href="#550" class="reference">Example Usage</a></li>
<li><a href="#551" class="reference">How does it work?</a></li>
</ul></li>
<li><a href="#552" class="reference">Test documentation</a></li>
</ul>
</section>
<section>
<h1 id="multi-source-raw-audio-mixer-549">Multi-source Raw Audio Mixer {#549}</h1>
<p>A component that mixes raw audio data from an unknown number of sources, that can change at any time. Audio data from each source is buffered until a minimum threshold amount, before it is included in the mix. The mixing operation is a simple addition. Values are not scaled down.</p>
<h2 id="example-usage-550"><span id="example-usage">Example Usage</span> {#550}</h2>
<p>Mixing up to 3 sources of audio (sometimes a source is active, sometimes it isn't):</p>
<pre class="literal-block"><code>Graphline(
    MIXER = RawAudioMixer( sample_rate=8000,
                           channels=1,
                           format=&quot;S16_LE&quot;,
                           readThreshold=1.0,
                           bufferingLimit=2.0,
                           readInterval=0.1),
                         ),
    A = pipeline( SometimesOn_RawAudioSource(), Entuple(prefix=&quot;A&quot;) ),
    B = pipeline( SometimesOn_RawAudioSource(), Entuple(prefix=&quot;B&quot;) ),
    C = pipeline( SometimesOn_RawAudioSource(), Entuple(prefix=&quot;C&quot;) ),

    OUTPUT = RawSoundOutput( sample_rate=8000,
                             channels=1
                             format=&quot;S16_LE&quot;,
                           ),
           linkages = {
               (A, &quot;outbox&quot;) : (MIXER, &quot;inbox&quot;),
               (B, &quot;outbox&quot;) : (MIXER, &quot;inbox&quot;),
               (C, &quot;outbox&quot;) : (MIXER, &quot;inbox&quot;),

               (MIXER, &quot;outbox&quot;) : (OUTPUT, &quot;inbox&quot;),
           },
         ).run()</code></pre>
<p>Each source is buffered for 1 second before it is output. If more than 2 seconds of audio are buffered, then samples are dropped.</p>
<h2 id="how-does-it-work-551"><span id="how-does-it-work">How does it work?</span> {#551}</h2>
<p>Send (id, raw-audio) tuples to RawAudioMixer's inbox. Where 'id' is any value that uniquely distinguishes each source of audio.</p>
<p>RawAudioMixer buffers each source of audio, and mixes them together additively, outputting the resulting stream of audio data.</p>
<p>Constructor arguments:</p>
<blockquote>
<ul>
<li>sample_rate, channels, format The format of audio to be mixed. The only format understood at the moment is "S16_LE"</li>
<li>readThreshold number of seconds of audio that will be buffered before RawAudioMixer starts mixing it into its output.</li>
<li>bufferingLimit maximum number of seconds of audio that will be buffered. If more piles up then some audio will be lost.</li>
<li>readInterval number of seconds between each time RawAudioMixer outputs a chunk of audio data.</li>
</ul>
</blockquote>
<p>RawAudioMixer buffers each source of audio separately. If the amount of audio in any buffer exceeds the 'buffering limit' then the oldest samples buffered will be lost.</p>
<p>When one or more buffered sources reaches the 'read threshold' then they are mixed together and output. How often audio is output is determined by setting the 'read Interval'.</p>
<p>Mixing is done additively and is <em>not</em> scaled down (ie. it is a sum() function, not an average() ). Therefore, ensure that the sum of the sources being mixed does not exceed the range of values that samples can take.</p>
<p>Why the buffering, thresholds, and read intervals? It is done this way so that RawAudioMixer can mix without needing to know what sources of audio there are, and whether they are running or stopped. It also enables RawAudioMixer to cope with audio data arriving from different sources at different times.</p>
<p>You may introduce new audio sources at any time - simply send audio data tagged with a new, unique identifier.</p>
<p>You may stop an audio source at any time too - simply stop sending audio data. The existing buffered data will be output, until there is not left.</p>
<p>If there is not enough audio in any of the buffers (or perhaps there are no sources of audio) then RawAudioMixer will not output anything, not even 'silence'.</p>
<p>If a shutdownMicroprocess or producerFinished message is received on this component's "control" inbox this component will cease reading in data from any audio sources. If it is currently outputting audio from any of its buffers, it will continue to do so until these are empty. The component will then forward on the shutdown message it was sent, out of its "signal" outbox and immediately terminate.</p>
<p>TODO:</p>
<blockquote>
<ul>
<li>Needs a timeout mechanism to discard very old data (otherwise this is effectively a memory leak!)
<ul>
<li>If an audio source sends less than the readThreshold amount of audio data, then stops; then this data never gets flushed out.</li>
</ul></li>
</ul>
</blockquote>
<h1 id="test-documentation-552">Test documentation {#552}</h1>
<p>Tests passed:</p>
<ul>
<li>Multiple sources of audio will be mixed</li>
<li>If there is no input (no incoming audio data), there will be no output (no outgoing audio data)</li>
<li>A single source of audio will pass through</li>
</ul>
</section>
<hr />
<h1 id="kamaelia.audio.rawaudiomixer.rawaudiomixer"><a href="/Components/pydoc/Kamaelia.html" class="reference">Kamaelia</a>.<a href="/Components/pydoc/Kamaelia.Audio.html" class="reference">Audio</a>.<a href="/Components/pydoc/Kamaelia.Audio.RawAudioMixer.html" class="reference">RawAudioMixer</a>.<a href="/Components/pydoc/Kamaelia.Audio.RawAudioMixer.RawAudioMixer.html" class="reference">RawAudioMixer</a></h1>
<h2 id="symbol-RawAudioMixer">class RawAudioMixer(<a href="/Docs/Axon/Axon.ThreadedComponent.threadedcomponent.html" class="reference">Axon.ThreadedComponent.threadedcomponent</a>)</h2>
<p>RawAudioMixer([sample_rate][,channels][,format][,readThreshold][,bufferingLimit][,readInterval]) -&gt; new RawAudioMixer component.</p>
<p>Mixes raw audio data from an unknown number of sources, that can change at any time. Audio data from each source is buffered until a minimum threshold amount, before it is included in the mix. The mixing operation is a simple addition. Values are not scaled down.</p>
<p>Send (uniqueSourceIdentifier, audioData) tuples to the "inbox" inbox and mixed audio data will be sent out of the "outbox" outbox.</p>
<p>Keyword arguments:</p>
<ul>
<li>sample_rate -- The sample rate of the audio in Hz (default=8000)</li>
<li>channels -- Number of channels in the audio (default=1)</li>
<li>format -- Sample format of the audio (default="S16_LE")</li>
<li>readThreshold -- Duration to buffer audio before it starts being used in seconds (default=1.0)</li>
<li>bufferingLimit -- Maximum buffer size for each audio source in seconds (default=2.0)</li>
<li>readInterval -- Time between each output chunk in seconds (default=0.1)</li>
</ul>
<h3 id="inboxes"><span id="symbol-RawAudioMixer.Inboxes">Inboxes</span></h3>
<h3 id="outboxes"><span id="symbol-RawAudioMixer.Outboxes">Outboxes</span></h3>
<h3 id="methods-defined-here">Methods defined here</h3>
<div class="container">
<div class="boxright">
<p><strong>Warning!</strong></p>
<p>You should be using the inbox/outbox interface, not these methods (except construction). This documentation is designed as a roadmap as to their functionalilty for maintainers and new component developers.</p>
</div>
</div>
<h4 id="init__self-sample_rate-channels-format-readthreshold-bufferinglimit-readinterval"><span id="symbol-RawAudioMixer.__init__">__init__(self[, sample_rate][, channels][, format][, readThreshold][, bufferingLimit][, readInterval])</span></h4>
<h4 id="checkforshutdownself"><span id="symbol-RawAudioMixer.checkForShutdown">checkForShutdown(self)</span></h4>
<h4 id="fillbufferself-buffers-data"><span id="symbol-RawAudioMixer.fillBuffer">fillBuffer(self, buffers, data)</span></h4>
<h4 id="mainself"><span id="symbol-RawAudioMixer.main">main(self)</span></h4>
<h4 id="mix_s16_leself-sources-amount"><span id="symbol-RawAudioMixer.mix_S16_LE">mix_S16_LE(self, sources, amount)</span></h4>
<section>

</section>
</div>
<h1 id="feedback">Feedback</h1>
<p>Got a problem with the documentation? Something unclear that could be clearer? Want to help improve it? Constructive criticism is very welcome - especially if you can suggest a better rewording!</p>
<p>Please leave you feedback <a href="../../../cgi-bin/blog/blog.cgi?rm=viewpost&amp;nodeid=1142023701" class="reference">here</a> in reply to the documentation thread in the Kamaelia blog.</p>
<p><em>-- Automatic documentation generator, 05 Jun 2009 at 03:01:38 UTC/GMT</em></p>

</div> <!-- end section -->
</div> <!-- end page container -->

<div class="banner">
<a href="https://www.bbc.co.uk/rd"><img src="/site-resources/BBCRD_Logo.jpg"></a>
<P id="mini">  Kamaelia is an open source project originated from and guided
by <a href="https://www.bbc.co.uk/rd">BBC Research.</a> For more information
browse the site or get in contact.
<br>This is an ongoing community based development site.  As a result the
contents of this page is the opinions of the contributors of the pages
involved not the organisations involved.  Specificially, this page may
contain personal views which are not the views of the BBC.

<br>(C) Copyright 2004-2024 Kamaelia Contributors, including the British
Broadcasting Corporation, All Rights Reserved.
</div>
</body>
</html>
